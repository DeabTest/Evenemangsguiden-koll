# fetch_events.py
import json
import re
import time
from pathlib import Path
from datetime import date
from playwright.sync_api import sync_playwright

TIME_RX = re.compile(r"\b\d{1,2}[:.]\d{2}\b")

def fetch():
    items = []
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page()
        page.goto("https://eskilstuna.nu/evenemang/")

        # Klicka på "Ladda fler" tills den försvinner
        while page.locator("button.load-more-button").is_visible():
            page.click("button.load-more-button")
            time.sleep(1.5)

        # Extrahera varje kort
        for card in page.locator(".event-card").all():
            url = card.locator("a.event-card-inner").get_attribute("href")
            url = f"https://eskilstuna.nu{url}"

            date_text = card.locator(".event-card-date").inner_text().strip()
            title = card.locator("h3").inner_text().strip()
            details = card.locator(".event-card-details").inner_text().strip()

            # Extrahera tid
            time_str = ""
            m_time = TIME_RX.search(details)
            if m_time:
                time_str = m_time.group(0)

            # Extrahera plats
            location = ""
            if m_time:
                lines = details[m_time.end():].strip().splitlines()
                for line in lines:
                    line = line.strip()
                    if line and not TIME_RX.search(line):
                        location = re.sub(r"^[^A-Za-zÅÄÖåäö]+", "", line)
                        break

            # Skapa ID
            eid = f"{date_text}_{title}_{time_str}_{location}".replace(" ", "_")

            items.append({
                "id": eid,
                "date": date_text,
                "title": title,
                "time": time_str,
                "location": location,
                "url": url
            })

        browser.close()
    return items


if __name__ == "__main__":
    events = fetch()
    output = Path("data")
    output.mkdir(exist_ok=True)
    file = output / f"events_{date.today().isoformat()}.json"
    with file.open("w", encoding="utf-8") as f:
        json.dump(events, f, ensure_ascii=False, indent=2)
    print(f"Fetched {len(events)} events → {file}")
